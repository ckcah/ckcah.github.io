<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ckcah.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="这是域内信息搜集，和web安全不同">
<meta property="og:type" content="article">
<meta property="og:title" content="域名信息搜集">
<meta property="og:url" content="https://ckcah.github.io/2020/07/24/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/index.html">
<meta property="og:site_name" content="bosch">
<meta property="og:description" content="这是域内信息搜集，和web安全不同">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-07-24T08:31:20.000Z">
<meta property="article:modified_time" content="2021-08-03T10:51:37.562Z">
<meta property="article:author" content="bosch">
<meta property="article:tag" content="网络安全">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ckcah.github.io/2020/07/24/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>域名信息搜集 | bosch</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">bosch</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">cheng</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>books</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/ckcah" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ckcah.github.io/2020/07/24/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/title1.jpg">
      <meta itemprop="name" content="bosch">
      <meta itemprop="description" content="在这片海洋中，如若无法向上攀游，就只有往下沉沦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="bosch">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          域名信息搜集
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-24 16:31:20" itemprop="dateCreated datePublished" datetime="2020-07-24T16:31:20+08:00">2020-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-08-03 18:51:37" itemprop="dateModified" datetime="2021-08-03T18:51:37+08:00">2021-08-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">网络安全</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">信息搜集</span></a>
                </span>
            </span>

          
            <span id="/2020/07/24/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/" class="post-meta-item leancloud_visitors" data-flag-title="域名信息搜集" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/07/24/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/07/24/%E5%9F%9F%E5%90%8D%E4%BF%A1%E6%81%AF%E6%90%9C%E9%9B%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>
            <div class="post-description">这是域内信息搜集，和web安全不同</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>keyword：我只是互联网的搬运工</strong></p>
<p>PS：这篇文章很长！是前辈ms08067团队出的书《内网安全攻防》里的内容（很不错），我都一一复现了一遍并做了笔记，请耐心观看。以后会有第三章，第四章…的笔记，佛系更新吧~</p>
<p>2.1 内网信息搜集概述<br>当渗透测试人员进入内网后，面对的是一片“黑暗森林”，所以渗透测试人员首先会对当前所处的网络环境进行判断，通常的判断分为三种。</p>
<p>我是谁？——对机器角色的判断。</p>
<p>这是哪？——对目前机器所处网络环境的拓扑结构进行分析和判断。</p>
<p>我在哪？——对目前机器所处位置区域的判断。</p>
<p>2.2 搜集本机信息<br>1：查询网络配置信息<br>获取本机网络配置信息：</p>
<p>ipconfig /all</p>
<span id="more"></span> 


<p>2：查询操作系统及软件的信息<br>（1）查询操作系统和版本信息</p>
<p>英文版系统用这条命令：<br>systeminfo | findstr /B /C:”OS Nmae” /C:”OS Version”</p>
<p>中文版系统用这条命令：<br>systeminfo | findstr /B /C:”OS 名称” /C:”OS 版本”<br>（2）查看系统体系结构</p>
<p>echo %PROCESSOR_ARCHITECTURE%</p>
<p>（3）查看安装的软件及版本、路径等</p>
<p>wmic product get name,version</p>
<p>（4）使用powershell命令，搜集软件的版本信息</p>
<p>powershell “Get-WmiObject -class Win32_Product |Select-Object -Property name,version”</p>
<p>3：查询本机服务信息</p>
<p>wmic service list brief</p>
<p>4：查询进程列表<br>查看当前进程列表和进程用户、分析软件、邮件客户端、vpn和杀毒软件等进程</p>
<p>tasklist</p>
<p>wmic process list brief</p>
<p>5：查看启动程序信息</p>
<p>wmic startup get command,caption</p>
<p>6：查看计划任务</p>
<p>schtasks /query /fo LIST /v</p>
<p>7：查看主机开机时间</p>
<p>net statistics workstation</p>
<p>8：查询用户列表<br>（1）查看有那些用户</p>
<p>net user</p>
<p>（2）获取本地管理员、包含域用户信息</p>
<p>net localgroup administrators</p>
<p>（3）查看当前在线用户</p>
<p>query user || qwinsta</p>
<p>（4）列出或断开本地计算机与所连接的客户端之间的会话</p>
<p>net session<br>（5）查询端口列表</p>
<p>netstat -ano</p>
<p>（6）查询补丁信息</p>
<p>systeminfo</p>
<p>wmic qfe get Caption,Description,HotFixID,InstalledOn</p>
<p>（7）查询本机共享列表</p>
<p>net share</p>
<p>wmic share get name,path,status</p>
<p>9：查询路由表及所有可用接口的ARP缓冲表</p>
<p>route print<br>arp -a</p>
<p>10：查询防火墙相关配置<br>（1）关闭防火墙</p>
<p>win 2003及之前的版本用这条命令：<br>netsh firewall set opmode disable</p>
<p>win 2003之后的版本用这条命令：<br>netsh advfirewall set allprofiles state off<br>（2）查看防火墙配置</p>
<p>netsh firewall show config</p>
<p>（3）修改防火墙配置</p>
<p>win 2003及之前的版本，运行指定程序全部连接：<br>netsh firewall add allowedprogram c:\nc.exe “allow nc” enable</p>
<p>win 2003之后的版本用这条：<br>netsh advfirewall firewall add rule name=”pass nc” dir=in action=allow program=”C:\nc.exe”</p>
<p>允许指定程序连出，命令如下<br>netsh advfirewall firewall add rule name=”Allow nc” dir=out action=allow program=”C: \nc.exe”</p>
<p>允许 3389 端口放行，命令如下<br>netsh advfirewall firewall add rule name=”Remote Desktop” protocol=TCP dir=in localport=3389 action=allow</p>
<p>自定义防火墙日志储存位置<br>netsh advfirewall set currentprofile logging filename “C:\windows\temp\fw.log”<br>11：查看代理配置情况</p>
<p>reg query “HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings”</p>
<p>12：查询并开启远程连接服务<br>（1）查看远程连接端口<br>在 cmd 下使用注册表查询语句，命令如下，得到连接端口为 0xd3d，转换后为 3389</p>
<p>REG QUERY “HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp” /V PortNumber</p>
<p>（2）在 Windows Server 2003 中开启 3389 端口</p>
<p>wmic path win32_terminalservicesetting where (__CLASS !=””)  call setallowtsconnections 1<br>（3）在Windows Server 2008和Windows Server 2012中开启3389端口</p>
<p>wmic /namespace:\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !=””) call setallowtsconnections 1</p>
<p>wmic /namespace:\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName=’RDP-Tcp’) call setuserauthenticationrequired 1</p>
<p>reg add “HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER” /v fSingleSessionPerUser /t REG_DWORD /d 0 /f<br>2.2 自动收集信息<br>使用WMIC自动脚本来收集信息,打开运行 wmic_info.bat 会自动生成一个 out.html 文件</p>
<p>Empire下的主机信息搜集<br>Empirer提供了收集主机的模块。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire.git">https://github.com/EmpireProject/Empire.git</a></p>
<p>2.3 查询当前权限<br>1、查看当前权限</p>
<p>whoami<br>本地管理员用户，或者是本地用户：</p>
<p>域内用户：</p>
<p>在以上三种情况下，如果当前内网中存在域，那么本地普通用户只能查询本机相关信息，不能查询域内信息；而本地管理员用户和域内用户可以查询域内信息。其原理是：域内的所有查询都是通过域控制器实现的（基于LDAP协议），而这个查询需要经过权限认证，所以只有域用户才拥有这个权限；当域用户执行查询命令时，会自动使用kerberos协议进行认证，无须额外输入账号密码。</p>
<p>2、获取域SID</p>
<p>whoami /all</p>
<p>当前域 hacker 的 SID 为：</p>
<p>3、查询指定用户的详细信息</p>
<p>net user 用户名 /domain</p>
<p>2.4 判断是否存在域<br>1、使用ipconfig命令</p>
<p>ipconfig /all</p>
<p>然后可以使用反向解析查询命令 nslookup 来解析域名的IP地址。用解析到的IP地址进行对比，判断域控制器和DNS服务器是否在同一台服务器上：</p>
<p>nclookup hacker.lab</p>
<p>2、查看系统详细配置<br>使用 systeminfo 命令，如果存在域就会显示：</p>
<p>如果不存在就会显示一个：WORKGROUP</p>
<p>3、查询当前登录域及登录用户信息<br>执行命令如果存在域那么就会显示工作站域和工作站域DNS等信息：</p>
<p>net config workstation</p>
<p>执行命令如果不存在域那么就会显示WORKGROUP：</p>
<p>4、判断主域<br>判断主域：域服务器通常会同时作为时间服务器使用</p>
<p>net time /domain<br>有三种情况，第一种中存在域，当前是域用户：</p>
<p>第二种是，不存在域，环境是工作组：</p>
<p>第三种是，存在域，但是当前用户不是域用户</p>
<p>2.5 探测域内存活主机<br>1、使用nbtscan<br>nbtscan是一个命令行工具，用于扫描本地或远程TCP/IP网络上开放的NetBIOS名称服务器。</p>
<p>NetBOIS是局域网程序使用的一种程序编程接口（API），为程序提供了请求低级别服务的统一命令集，为局域网提供了网络及其他特殊功能。几乎所有局域网都是在NetBIOS协议的基础上工作的。NetBIOS也是计算机的标识名，主要用于局域网中计算机的互访问。NetBIOS的工作流程就是正常的机器名解析查询应答过程，因此推荐优先使用。</p>
<p>使用命令格式：</p>
<p>nbtscan.exe 10.10.10.0/20</p>
<p>第一列为IP地址，第二列为机器名和所在域的名称，第三列是机器所开启的服务列表。</p>
<p>服务列表具体含义：</p>
<p>Token：            含义：<br>SHARING             该机器中存在运行的文件和打印共享服务，但不一定有内容共享<br>DC                 该机器可能是域控制器<br>U=USER             该机器中有登陆名为User的用户（不太准确）<br>IIS                 该机器中可能安装了IIS服务<br>EXCHANGE         该机器中可能安装了Exchane<br>NOTES             该机器中可能安装了Lotus Notes电子邮箱客户端<br>？                 没有识别出机器的NetBIOS资源（可以使用 -F 选项再次扫描）</p>
<p>2、利用ICMP协议快速探测内网<br>除了使用NetBIOS探测内网，还可以使用ICMP协议去探测内网情况。</p>
<p>使用ping命令，依次对内网中的每个IP地址执行Ping命令，可以快速找出内网中所有存活的主机（比较慢）：</p>
<p>for /L %I in (1,1,254) DO @ping -w 1 -n 1 10.10.10.%I | findstr “TTL=”</p>
<p>还可以使用VBS脚本进行探测，脚本源代码如下：</p>
<p>strSubNet = “10.10.10.”<br>Set objFSO= CreateObject(“Scripting.FileSystemObject”)<br>Set objTS = objfso.CreateTextFile(“C:\Windows\Temp\Result.txt”)<br>For i = 1 To 254<br>strComputer = strSubNet &amp; i<br>blnResult = Ping(strComputer)<br>If blnResult = True Then<br>objTS.WriteLine strComputer &amp; “ is alived ! :) “<br>End If<br>Next<br>objTS.Close<br>WScript.Echo “All Ping Scan , All Done ! :) “<br>Function Ping(strComputer)<br>Set objWMIService = GetObject(“winmgmts:\.\root\cimv2”)<br>Set colItems = objWMIService.ExecQuery(“Select * From Win32_PingStatus Where Address=’” &amp; strComputer &amp; “‘“)<br>For Each objItem In colItems<br>Select case objItem.StatusCode<br>Case 0<br>Ping = True<br>Case Else<br>Ping = False<br>End select<br>Exit For<br>Next<br>End Function<br>运行命令：cscript 1.vbs（速度很慢）</p>
<p>运行完后它会把结果保存到C:\Windows\Temp\Result.txt 中：</p>
<p>3、通过ARP扫描探测内网<br>3.1：apr-scan工具<br>把arp-scan工具上传到目标主机上，可以自定义子网掩码，指定扫描范围，命令如下：</p>
<p>arp-scan.exe -t 10.10.10.0/20</p>
<p>3.2:Empire中的arpscan模块<br>下载地址：<a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire">https://github.com/EmpireProject/Empire</a></p>
<p>PS：在这里安装Empire需要更改一下格式：<a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/215817f788e8c21eda1423ea.html">https://jingyan.baidu.com/article/215817f788e8c21eda1423ea.html</a></p>
<p>Empire中内置了arpscan的模块，这个模块可以在局域网内发送ARP数据包，搜集活跃主机的IP地址、MAC地址信息。</p>
<p>usemodule situational_awareness/network/arpscan</p>
<p>3.3：Nishang中的Invoke-ARPScan.ps1脚本<br>使用 Nishang 中的 Invoke-ARPScan.ps1 脚本，可以将脚本上传到目标主机执行，也可以直接远程加载执行、自定义掩码和扫描范围，命令如下：</p>
<p>powershell.exe -exec bypass -Command “Import-Module C:\Invoke-ARPScan.ps1;Invoke-ARPScan -CIDR 192.168.1.0/24” &gt;&gt; result.txt</p>
<p>4、通过常规TCP/UDP端口扫描探测内网<br>ScanLine 是一款经典的端口扫描工具，Windows 全版本通用，体积小，仅使用单个文件，同时支持对 TCP/UDP 的端口扫描，命令如下：</p>
<p>scanline.exe -h -t 22,80,110,389,445,3389,1099,1433,3306,3389 -u 53,161,137,139 -O log.txt -p 10.10.10.1-254 /b</p>
<p>2.6 扫描域内端口<br>通过查询目标主机的端口开放信息，不仅可以了解目标主机所开放的服务，还可以找出其开放服务的漏洞、分析目标的网络拓扑结构等，具体需要关注以下三点。</p>
<p>端口的 Banner 信息。</p>
<p>端口上运行的服务。</p>
<p>常见应用的默认端口</p>
<p>1：利用Telnet命令进行扫描<br>Telnet协议是TCP/IP协议的一种，是Internet远程登录服务的标准协议和主要方式。它为用户提供了在本地计算机上完成远程工作的能力。</p>
<p>在目标主机上使用telnet协议，可以与目标服务器建立连接。如果只是想快速探测某太主机的某个常规高危端口是否开放，使用telnet命令就可以做到！</p>
<p>telnet DC 端口</p>
<p>2：使用S扫描器<br>S 扫描器是早期的一种比较快速的端口扫描工具，特别适合运行在 Windows Sever 2003 以下的平台上，支持大网段扫描。S 扫描器的扫描结果默认保存在其目录下的 result.txt 文件中。推荐使用 TCP 扫描，命令如下：</p>
<p>S.exe TCP 10.10.10.1 10.10.10.254 445,3389,1433,7001,1099,8080,80,22,23,21,25,110,3306,5432,1521,6379,2049,111 256 /Banner /save</p>
<p>3：使用Metasploit端口扫描<br>MSF这里就不多介绍了，我博客 <a target="_blank" rel="noopener" href="http://www.saulgoodman.cn/">www.saulGoodman.cn</a> 里面讲了MSF的使用，端口扫描使用这个模块 :</p>
<p>auxiliary/scanner/portscan/tcp：</p>
<p>4：使用PowerScript的Invoke-portscan.ps1脚本<br>以无文件形式扫描，命令如下：</p>
<p>powershell.exe -nop -exec bypass -c “IEX (New-Object Net.WebClient).DownloadString(‘<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#39;);Invoke-Portscan">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1&#39;);Invoke-Portscan</a> -Hosts 192.168.1.0/24 -T 4 -ports ‘445,1433,8080,3389,80’ -oA c:\windows\temp\res.txt”</p>
<p>使用还是挺不错的，速度挺快。</p>
<p>5：使用Nishang的Invoke-PortScan模块<br>Invoke-PortScan 是 Nishang 的端口扫描脚本，用于发现主机、解析主机名、端口扫描，是一个很实用的脚本。输入“Get-Help Invoke-PortScan -full”命令，即可查看帮助信息</p>
<p>具体的参数介绍如下。<br>StartAddress：扫描范围开始的地址。<br>EndAddress：扫描范围结束的地址。<br>ScanPort：进行端口扫描。<br>Port：指定扫描端口。默认扫描的端口有 21、22、23、53、69、71、80、98、110、139、<br>111、389、443、445、1080、1433、2001、2049、3001、3128、5222、6667、6868、7777、<br>7878、8080、1521、3306、3389、5801、5900、5555、5901。<br>TimeOut：设置超时时间。<br>使用以下命令对本地局域网进行扫描，搜索存活主机并解析主机名：<br>Invoke-PortScan -StartAddress 192.168.250.1 -EndAddress 192.168.250.255 -ResolveHost</p>
<p>6：端口Bannner信息<br>如果发现了端口，但是不确定这个端口是什么服务，就可以利用一些nc来获取这个端口的banner信息，就好比这样 ：</p>
<p>2.7 搜集域内基础信息<br>确定了当前内网拥有的域，并且所控制的主机在域里面，就可以进行域内相关信息的收集了。</p>
<p>因为这些查询命令本质上都是通过 LDAP 协议去域控制器上查询的，查询时候需要经过权限认证，只有域用户才有这个权限，所以本地用户是无法运行以下命令的（system 权限用户除外。在域里面，除了普通用户，所有机器都有一个机器用户，用户名为机器名加“$”。system 用户对应的就是域里面的机器用户，所以 system 权限用户是可以运行以下查询命令的）。</p>
<p>1：查询域</p>
<p>net view /domain</p>
<p>这里有个坑，有时候查询出错6118错误，是因为 Computer Brower 服务的问题，把它手动启动。</p>
<p>2：查询域内所有计算机<br>执行以下命令就可以查询得到主机名对主机角色进行初步判断：</p>
<p>net view /domain:HACKER[主机名]</p>
<p>3：查询域内所有用户组列表</p>
<p>net group /domain</p>
<p>4：查询所有域成员计算机列表</p>
<p>net group “domain computers” /domain</p>
<p>5：获取域密码信息<br>获取域密码策略、密码长度、错误锁定等信息用这条命令：</p>
<p>net accounts /domain</p>
<p>6：获取域信任信息</p>
<p>nltest /domain_trusts</p>
<p>2.8 查找域控制器<br>1：查看域控制器的机器名</p>
<p>nltest /DCLIST:主机名[Hacker]</p>
<p>2：查看域控制器主机名</p>
<p>Nslookup -type=SRV _ldap._tcp</p>
<p>3：查看当前时间<br>在通常情况下，时间服务器为主域控制器：</p>
<p>net time /domain</p>
<p>4：查看域控制器组</p>
<p>net group “Domain Controllers” /domain</p>
<p>PS：在实际情况中，一个域内一般有两台或者两台以上的域控制器，因为一点主域控制器发生故障，备用域控制器就可以保证域内服务和验证工作正常运行。</p>
<p>执行以下命令查看主域控制器为DC：</p>
<p>netdom query pdc</p>
<p>2.9 获取域内的用户和管理员信息<br>1：查询所有域用户列表<br>1.1：向域控制器进行查询<br>执行以下命令，向域控制器DC查询，域内有5个用户，其中krbtgt用户不仅可以创建票据授权服务（TGS）的加密密钥，还可以实现多种域内权限持久化方法。</p>
<p>net user /domain</p>
<p>1.2：获取域内用户的详细信息<br>执行下面的命令可以获取域内用户的详细信息：用户名、描述信息、SID、域名等等</p>
<p>wmic useraccount get /all</p>
<p>1.3：查看存在的用户<br>执行以下命令会发现有五个用户：</p>
<p>dsquery user</p>
<p>关于 dsquery 命令还有如下：</p>
<p>1.4：查询本地管理员组用户</p>
<p>net localgroup administrators</p>
<p>默认 Domain Admins 组为域内机器的本地管理员用户。在真实环境中，为了方便管理，会有域用户被添加为域机器的本地管理员用户。</p>
<p>2：查询域管理员用户组<br>2.1：查询域管理员用户</p>
<p>net group “domain admins” /domain</p>
<p>2.2：查询域管理员用户组</p>
<p>net group “Enterprise Admins” /domain</p>
<p>2.10 定位域管理员<br>1：域管理员定位概述<br>内网渗透测试与常规的渗透测试是截然不同的。内网渗透测试的需求是拿到内网中特定用户或特定机器的权限，进而获得特定资源，完成内网渗透测试任务。</p>
<p>内网渗透测试与常规的渗透测试是截然不同的。内网渗透测试的需求是拿到内网中特定用户或特定机器的权限，进而获得特定资源，完成内网渗透测试任务。在通常的网络环境里，内网中部署了大量的网络安全设备，如 IDS、IPS、日志审计、安全网关、反病毒软件等。所以，在域网络攻击测试场景中，如果渗透测试人员获取了域内的一个支点，为了实现对域网络的整体控制，渗透测试人员就需要获取域管理员权限。</p>
<p>在一个域中，当计算机加入域后，会默认给域管理员组赋予本地系统管理员的权限。也就是说，在计算机添加到域中，成为域的成员主机后，系统会自动将域管理员组添加到本地系统管理员组中。因此，域管理员组的成员均可访问本地计算机，而且具备完全控制权限。</p>
<p>渗透测试人员通常会通过搜集域内信息，追踪域内特权用户、域管理组用户的历史登录位置、当前登录位置等。定位域内管理员的常规渠道，一是日志，二是会话。日志是指本地机器的管理员日志，可以使用脚本或 wevtutil 导出查看。会话是指域内每个机器的登录会话，可以匿名查询，无须权限，可以使用 netsess.exe 或 PowerView 等工具查询。</p>
<p>2：常用域管理员定位工具<br>2.1：psloggedon.exe<br>使用psloggedon.exe，可以查看本地登录的用户和通过本地计算机或远程计算机资源登录的用户。如果指定的是用户名而不是计算机名，psloggedon.exe会搜索网上邻居中的计算机，并显示该用户当前是否登录。其原理就是通过检查注册表 HKEY_USERS 项的 key 值来查询谁登录过（需要调用NetSessionEnum API），但某些功能需要管理员权限才能使用。</p>
<p>使用语法：<br>-：显示支持的选项和用于输出值的单位。<br>-l：仅显示本地登录，不显示本地和网络资源登录。<br>-x：不显示登录时间。<br>\computername：指定要列出登录信息的计算机的名称。<br>Username：指定用户名，在网络中搜索该用户登录的计算机。</p>
<p>2.2：PVEFindADUser.exe<br>PVEFindADUser.exe这款工具可用于查找活动目录用户登录的位置、枚举域用户，以及查找在特定计算机上登陆的用户，包括本地用户、通过RDP登陆的用户、用于运行服务和计划任务的用户。运行该工具的计算机需要配置 .NET Framework 2.0 环境，并且需要具有管理员权限。</p>
<p>使用语法：<br>pveFindADUser.exe &lt;参数&gt;<br>-h：显示帮助。<br>-u：检查是否有更新版本的实用程序。<br>-current [‘’username’’]：如果仅指定了-current 参数，将获取所有目标计算机上当前登录的所有用户。如果指定了用户名（DOMAIN\Username），则显示该用户登录的计算机。<br>-last [‘’username’’]：如果仅指定了-last 参数，将获取目标计算机上的最后一个登录用户。如果指定了用户名（DOMAIN\Username），则显示具有此用户账户作为上次登录的计算机。根据网络的策略，可能会隐藏最后一个登录用户名，且该工具可能无法得到该用户名。 -noping：阻止该工具在尝试获取用户登录信息之前对目标计算机执行 ping 命令。<br>-target：可选参数，用于指定要查询的主机。如果未指定此参数，将查询当前域中的所有主机。如果指定此参数，则后跟一个由逗号分隔的主机名列表。</p>
<p>2.3：netview.exe<br>netview.exe 是一个枚举工具，使用 WinAPI 枚举系统，利用NetSessionEnum找寻登陆会话，利用NetShareEnum找寻共享，利用NetWkstaUserEnum枚举登陆的用户。同时，netview.exe 能够查询共享入口和有价值的用户。netview.exe的绝大部分功能不需要管理员权限就可以使用。</p>
<p>使用语法：<br>netview.exe &lt;参数&gt;<br>-h：显示帮助菜单。<br>-f filename.txt：指定从中提取主机列表的文件。<br>-e filename.txt：指定要排除的主机名文件。<br>-o filename.txt：将所有输出重定向到文件。<br>-d domain：指定从中提取主机列表的域。如果没有指定，则使用当前域。<br>-g group：指定用户搜寻的组名。如果没有指定，则使用 Domain Admins。<br> -c：检查对已找到共享的访问权限。</p>
<p>2.4：Nmap的NSE脚本<br>如果有域账户或者本地账户，就可以使用 Nmap 的 smb-enum-sessions.nse 引擎来获取远程机器的登录会话，并且不需要管理员权限。smb-enum-sessions.nse 的下载地址为：<a target="_blank" rel="noopener" href="https://nmap.org/nsedoc/scripts/smb-enum-sessions.html%E3%80%82">https://nmap.org/nsedoc/scripts/smb-enum-sessions.html。</a></p>
<p>smb-enum-domains.nse：对域控制器进行信息收集，可以获取主机信息、用户、密码策略可<br>以使用的用户等。<br>smb-enum-users.nse：在进行域渗透测试的时候，如果获取了域内某台主机的权限，但是权限有限，不能获取更多的域用户信息，就可以借助这个脚本对域控制器进行扫描。<br>smb-enum-shares.nse：遍历远程主机的共享目录。<br>smb-enum-processes.nse：对主机的系统进程进行遍历。通过这些信息，可以知道目标主机上运行软件信息，选择合适的漏洞或者规避防火墙及杀毒软件。<br>smb-enum-sessions.nse：获取域内主机的用户登录会话，查看当前是否有用户登录。<br>smb-os-discovery.nse：收集目标主机的操作系统、计算机名、域名、全称域名、域林名称、NetBIOS 机器名、NetBIOS 域名、工作组、系统时间。</p>
<p>2.5：PowerView脚本<br>PowerView是一款powershell脚本，提供了辅助定位关键用户的功能。</p>
<p>Invoke-StealthUserHunter ：只需要一次查询，就可以获取域内的所有用户。从user.HomeDirectories 中提取所有用户，并对每个服务器进行 Get-NetSessions 获取。因为不需要使用 Invoke-UserHunter 对每台机器进行操作，所以这个方法的隐蔽性相对较高，但涉及的机器面不一定完整。默认使用 Invoke-StealthUserHunter，如果找不到需要的信息，就接着使用 Invoke-UserHunter 方法。</p>
<p>Invoke-UserHunter：找到域内特定的用户群。它接收用户名、用户列表或域组查询，并接收一个主机列表或查询可用的主机域名。它会使用 Get-NetSessions 和 Get-NetLoggedon（调用 NetSessionEnum 和 NetWkstaUserEnum API）扫描每个服务器，而且会比较结果，筛选出目标用户集。使用这个工具是不需要管理员权限的。在本地绕过执行该脚本。</p>
<p>2.6：Empire下的user_hunter模块<br>在 Empire 下也存在类似 Invoke-UserHunter 的模块——user_hunter，这个模块就是用来查找域管理员登录的机器的。</p>
<p>使用 usemodule situational_awareness/network/powerview/user_hunter 模块可以清楚地看到哪个用户登录了哪台主机。在这里，显示域管理员曾经登录了机器名为 WIN7-64.shuteer.testlab、IP 地址为 192.168.31.251 的机器。</p>
<p>2.11 查找域管理进程<br>一个典型的域权限提升过程通常围绕着收集明文凭据或者通过 Mimikatz 来获得提升的权限等方法，然后在其所获取管理员权限的系统中寻找域管理员登录进程，从而收集域管理员的凭据。</p>
<p>我们来看一种假设的情况：渗透测试人员在某个内网环境中获得了一个域普通用户的权限，首先通过各种方法获得当前服务器的本地管理员权限，然后分析当前服务器的用户登录列表及会话信息，找出有哪些用户登录了这台服务器上。如果渗透测试人员通过分析发现，可以获取权限的登录用户都不是域管理员账户，同时也没有域管理员组的用户登录这台服务器，那么他会选择另一个账户，继续寻找这个账户在内网哪个机器上具有管理权限，再枚举这台机器上的登录用户，并继续进行渗透测试，直至找到一个有效的路径可以获取到域管理员权限为止。在具有成千上万台计算机和用户的环境中，该过程可能需要几天甚至几周的时间。</p>
<p>1：本机检查<br>1.1：获取域管理员列表</p>
<p>net group “Domain Admins” /domain<br>当前有一个域管理员：administrator</p>
<p>1.2：列出本机所有进程及进程用户</p>
<p>tasklist /v</p>
<p>1.3：寻找进程所有者为域管理员的进程<br>通过以上操作可以看出，当前存在域管理员进程，这种方法只是有几率能查找到域管理员进程，在实际情况下往往并非如此。</p>
<p>2：查询域控制器的域用户会话<br>查询域控制器的域用户会话，其原理是：在域控制器中查询域用户会话列表，并将其与域管理员列表进行交叉引用，从而得到域管理员会话的系统列表。</p>
<p>2.1：查询域控制器列表<br>可以使用LDAP查询从Domain Controlles单元中收集的域控制器列表。也可以使用net命令查询域控制器列表。</p>
<p>net group “Domain Controllers” /domain</p>
<p>2.2：收集域管理员列表<br>可以使用LDAP进行查询。也可以使用net命令，从域管理员组中收集域管理员列表。</p>
<p>net group “Domain Admins” /domain</p>
<p>2.3：收集所有活动域的会话列表<br>使用netsess.exe查询每个域控制器，收集所有活动域会话列表。netsess.exe它包含本地Windows函数netsessionenum。</p>
<p>netsess.exe -h</p>
<p>2.4：交叉引用域管理员列表与活动会话列表<br>对域管理员列表和活动会话列表进行交叉引用，可以确定哪些IP地址有活动域令牌。也可以通过下列脚本快速使用netsess.exe的Windows命令行。</p>
<p>将域控制器列表添加到dcs.txt中，将域管理员列表添加到admins.txt中，并与netsess.exe放在同一目录下，运行脚本会在当前目录下生成一个文本文件sessions.txt：</p>
<p>FOR /F %i in (dcs.txt) do @echo [+] Querying DC %i &amp;&amp; @netsess -h %i 2&gt;nul &gt; sessions.txt &amp;&amp; FOR /F %a in (admins.txt) DO @type sessions.txt | @findstr /I %a</p>
<p>3：查询远程系统中运行的任务<br>如果目标机器在域系统中是通过共享的本地管理员账户运行的，就可以使用下列脚本来查询系统中的域管理员任务。</p>
<p>首先，从Domain Admins组中收集域管理员列表：</p>
<p>net group “Domain Admins” /domain</p>
<p>然后运行如下脚本，将目标域系统列表添加到ips.txt文件中，将收集的域管理员列表添加到names.txt文件中：</p>
<p>FOR /F %i in (ips.txt) DO @echo [+] %i &amp;&amp; @tasklist /V /S %i /U user /P password 2&gt;NUL &gt; output.txt &amp;&amp; FOR /F %n in (names.txt) DO @type output.txt | findstr %n &gt; NUL &amp;&amp; echo [!] %n was found running a process on %i &amp;&amp; pause</p>
<p>4：扫描远程系统的NetBIOS信息<br>某些版本的Windows操作系统允许用户通过NetBIOS查询已登录用户，下面这个Windows命令行脚本就用于扫描远程系统活跃域中的管理会话。</p>
<p>for /F %i in (ips.txt) do @echo [+] Checking %i &amp;&amp; nbtstat -A %i 2&gt;NUL &gt;nbsessions.txt &amp;&amp; FOR /F %n in (admins.txt) DO @type nbsessions.txt | findstr /I %n &gt; NUL &amp;&amp; echo [!] %n was found logged into %i<br>同样，吧目标域系统列表添加到ips.txt文件中，将收集的域管理员列表添加到admins.txt文件中，同目录运行脚本：</p>
<p>2.12 域管理员模拟方法简介<br>如果您已经有一个 meterpreter 会话，您可以使用 Incognito模拟域管理员，或添加一个新的域 管理员。通过尝试遍历系统中所有可用的授权令牌来随意添加新的管理员。</p>
<p>2.13 利用PowerShell收集域信息<br>PowerShell可以理解为增强版的”cmd.exe”，打开方式就是：运行-&gt;输入powershell：</p>
<p>如果想执行一个Powershell脚本，需要修改Powershell的默认权限为执行权限。PowerShell常用的执行权限有四种：</p>
<p>Restricted：默认设置，不允许执行任何脚本。<br>Allsigned：只能运行经过证书验证的脚本。<br>Unrestricted：权限最高，可以执行任意脚本。<br>RemoteSigned：本地脚本无限制，但是对来自网络的脚本必须经过签名。<br>在PowerShell中输入Get-ExecutionPolicy，可以查看权限：</p>
<p>如果想要修改权限就可以执行这条命令，然后选择Y：</p>
<p>Set-ExecutionPolicy 权限名</p>
<p>powerview<br>powerview这个脚本是一款依赖于 powershell 和 WMI 对内网进行查询的常用渗透测试脚本。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a></p>
<p>导入脚本 powerview.ps1：</p>
<p>import-module .\powerview.ps1</p>
<p>Powerview中常用的命令</p>
<p>Get-NetDomain：获取当前用户所在的域名称。<br>Get-NetUser：返回所有用户的详细信息。<br>Get-NetDomainController：获取所有域控制器。<br>Get-NetComputer：获取所有域内机器的详细信息。<br>Get-NetOU：获取域中的 OU 信息。<br>Get-NetGroup：获取所有域内组和组成员信息。<br>Get-NetFileServer：根据 SPN 获取当前域使用的文件服务器。<br>Get-NetShare：获取当前域内所有网络共享。<br>Get-NetSession：获取在指定服务器存在的会话信息。<br>Get-NetRDPSession：获取在指定服务器存在的远程连接信息。<br>Get-NetProcess：获取远程主机的进程信息。<br>Get-UserEvent：获取指定用户的日志信息。<br>Get-ADObject：获取活动目录的对象信息。<br>Get-NetGPO：获取域所有组策略对象。<br>Get-DomainPolicy：获取域默认或域控制器策略。<br>Invoke-UserHunter：用于获取域用户登录计算机及该用户是否有本地管理权限。<br>Invoke-ProcessHunter：查找域内所有机器进程用于找到某特定用户。<br>Invoke-UserEventHunter：根据用户日志获取某域用户登录过哪些域机器。<br>获取当前用户所在的域名称</p>
<p>Get-NetDomain</p>
<p>返回所有用户的详细信息</p>
<p>获取所有域控制器</p>
<p>Get-NetDomainController</p>
<p>获取所有域内机器的详细信息</p>
<p>Get-NetComputer</p>
<p>获取域中的 OU 信息</p>
<p>Get-NetOU</p>
<p>获取所有域内组和组成员信息</p>
<p>Get-NetGroup</p>
<p>根据 SPN 获取当前域使用的文件服务器</p>
<p>Get-NetFileServer</p>
<p>获取当前域内所有网络共享</p>
<p>Get-NetShare</p>
<p>获取在指定服务器存在的会话信息</p>
<p>Get-NetSession</p>
<p>获取在指定服务器存在的远程连接信息</p>
<p>Get-NetRDPSession</p>
<p>获取远程主机的进程信息</p>
<p>Get-NetProcess</p>
<p>获取指定用户的日志信息</p>
<p>Get-UserEvent</p>
<p>获取活动目录的对象信息</p>
<p>Get-ADObject</p>
<p>获取域所有组策略对象</p>
<p>Get-NetGPO</p>
<p>获取域默认或域控制器策略</p>
<p>Get-DomainPolicy</p>
<p>用于获取域用户登录计算机及该用户是否有本地管理权限</p>
<p>Invoke-UserHunter</p>
<p>查找域内所有机器进程用于找到某特定用户</p>
<p>Invoke-ProcessHunter</p>
<p>根据用户日志获取某域用户登录过哪些域机器</p>
<p>Invoke-UserEventHunter</p>
<p>CMD运行powershell</p>
<p>powershell -exec bypass “import-module c:\powerview.ps1;get-netuser”</p>
<p>2.14 域渗透分析工具bloodhound的使用<br>安装BloodHound所需环境</p>
<p>1、下载安装JDK<br>JDK8下载地址：<a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase-jdk8-downloads.html">https://www.oracle.com/java/technologies/javase-jdk8-downloads.html</a></p>
<p>2、下载安装Neo4j<br>下载地址：<a target="_blank" rel="noopener" href="https://neo4j.com/download-center/#releases">https://neo4j.com/download-center/#releases</a></p>
<p>3、启动Neo4j数据库服务端<br>下载好后，进入对应的目录在命令行运行如下命令启动（必须安装JDK环境才可以）</p>
<p>cd C:\neo4j-community-3.5.3\bin<br>neo4j.bat console</p>
<p>通过浏览器打开：<a target="_blank" rel="noopener" href="http://localhost:7474/">http://localhost:7474/</a></p>
<p>打开后设置一下密码：原密码neo4j，修改为：123456（任意）</p>
<p>4、下载BloodHound<br>下载地址：<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/releases">https://github.com/BloodHoundAD/BloodHound/releases</a></p>
<p>然后打开：</p>
<p>输入账号密码：eno4j、123456</p>
<p>查找所有域管理员。<br>寻找到达域管理员的最短路径。<br>查找具有 dcsync权限的主体。<br>具有外部域组成员身份的用户。<br>具有外部域组成员身份的组。<br>映射域信任。<br>无约束委托系统的最短路径。<br>从 KerberoAstable 用户获得的最短路径。<br>从 KerberoAstable 用户到域管理员的最短路径。<br>拥有主体的最短路径。<br>从所属主体到域管理员的最短路径。<br>高价值目标的最短路径。<br>再下载：<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.exe">https://github.com/BloodHoundAD/BloodHound/blob/master/Ingestors/SharpHound.exe</a></p>
<p>放到C盘下：</p>
<p>然后运行：</p>
<p>SharpHound.exe -c all</p>
<p>运行完后会在当前路径下生成一个文件：2020032.png”-webkit-tap-highlight-color: rgba(0, 0, 0, 0);font-size: 14.6667px;margin-top: 1em;margin-bottom: 1em;color: rgb(22, 18, 9);font-family: “Microsoft Jhenghei”, “Lantinghei SC”, lanting, “PingFang SC”, “Seguo UI”, “Microsoft Yahei”, Arial;white-space: normal;background-color: rgb(255, 255, 255);”&gt;</p>
<p>然后我们吧他拖进去上传：</p>
<p>这个时候就有数据了：</p>
<p>查找所有域管理员</p>
<p>寻找最短到达域管理员的路径</p>
<p>查找具有 dcsync权限的主体</p>
<p>查看指定用户与域关联的详细信息<br>点一下用户就会在左边显示：</p>
<p>参考文章：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/179002.html">https://www.freebuf.com/sectool/179002.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/KevinGeorge/p/10513211.html">https://www.cnblogs.com/KevinGeorge/p/10513211.html</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/10643132.html">https://www.cnblogs.com/backlion/p/10643132.html</a></p>
<p>2.15 敏感数据防护<br>内网核心敏感数据，不仅仅包括数据库、电子邮件。还包括个人数据及组织的业务数据…可以说，价值高的数据基本上都在内网中，所以要了解攻击者的操作流程，这会对内网数据安全防护工作至关重要。</p>
<p>1：资料、数据、文件的定位流程<br>内网数据防护的第一步，就是要熟悉攻击者获取数据的流程。在实际的网络环境中，攻击者主要通过各种恶意方法来定位公司内部各相关人员的机器。从而获取资料、数据、文件等重要信息。文件定位大致流程如下：</p>
<p>定位内部人事组织结构</p>
<p>在内部人事组织结构中寻找需要监视的人员</p>
<p>定位相关人员的机器</p>
<p>监视相关人员存放文档的位置</p>
<p>列出存放文档的服务器的目录</p>
<p>2：重点核心业务机器及敏感信息防护<br>重点核心业务机器是攻击者比较关心的机器，因此，我们需要对这些机器采取相应的安全防护措施。</p>
<p>1．核心业务机器<br>高管/系统管理员/财务/人事/业务人员的个人计算机。<br>产品管理系统服务器（仓库管理系统） 。<br>OA 办公系统服务器。<br>财务应用系统服务器。<br>核心产品源码服务器（对于 IT公司，会架设自己的 SVN 或者 GIT 服务器） 。<br>数据库服务器。<br>文件服务器/共享服务器。<br>邮件服务器。<br>网络监控系统服务器。<br>其他服务器（分公司、工厂）。</p>
<p>2．各类敏感文件信息<br>站点源码备份文件、数据库备份文件、配置文件备份等（后缀 XX.zip，XX.sql 等） 。<br>各类数据库的 Web 管理入口，如 phpmyadmin、adminer等。<br>浏览器密码和浏览器 cookie（IE、Chrome、Firefox） 。<br>其他用户会话、3389 和 ipc$连接记录、各用户回收站的信息等。<br>Windows 无线密码。<br>目标内部的各种账号和密码信息，包括邮箱、VPN、FTP、TeamView 等。<br>3：应用于文件形式信息的防护<br>总体来说，渗透测试人员对于这一步的工作，一是要了解已攻陷机器所属人员的职位（通常 一个高职位的人在内网中的权限比一般员工要高，在他的计算机内也会有很多重要的、敏感的个 人或公司内部文件），二是要在该机器中通过一些搜索命令来寻找自己所需要的资料。用户在内网 中工作时，建议不要将一些特别重要的资料放在公开的计算机中，必要时一定要对 Office 文档进 行加密，密码也不要太过于简单（对低版本的 Office 软件，如 Office 2003，在网上很容易找到一些破解软件进行破解；对高版本的 Office 软件，也可以通过微软 Sysinternals Suite 套件中的抓取 Dump 的工具 procdump 来获取密码） 。</p>
<p>2.16 分析域内网段划分情况及拓扑图结构<br>要养成一个习惯，在掌握了内网相关信息后，可以做一个拓扑图来帮助我们分析内网网络的分布情况。</p>
<p>1：基本架构<br>我们还需要对目标网站的基本情况进行简单的判断，分析目标服务器所使用的Web服务器、后端脚本、数据库、系统平台等。</p>
<p>ASP + Access + IIS 5.0/6.0 + Windows Sever 2003</p>
<p>ASPX + MSSQL + IIS 7.0/7.5 + Windows Sever 2008</p>
<p>PHP + MySQL + IIS</p>
<p>PHP + MySQL + Apache</p>
<p>PHP + MySQL + Ngnix</p>
<p>JSP + MySQL + Ngnix</p>
<p>JSP + MSSQL + Tomcat</p>
<p>JSP + Oracle + Tomcat</p>
<p>2：域内网划分<br>内网的环境判断，首先需要分析内网 IP 地址的分布情况。一般可以通过内网中的路由器、交 换机等设备，以及 SNMP、弱口令等，来获取内网网络拓扑或 DNS 域传送的信息。一般的大公司 都会有内部网站，渗透测试人员也可通过内部网站的公开链接找出部门的 IP 地址段。内部网络是怎么划分的？是按照部门划分网段，按照楼层划分网段，还是按照地区划分网段？内网通常可分为 DMZ 区、办公区和核心区（生产区） 。了解整个内网的网络分布和组成，也有助 于渗透测试人员了解内网的核心业务。</p>
<p>1．DMZ 区<br>在实际的渗透测试中，大多数情况下，在外围 Web 中拿到的权限在 DMZ 区。这个区域不属 于严格意义上的内网。如果 DMZ 区域访问控制策略配置合理，DMZ 区会处在内网区能够访问 DMZ 区而 DMZ 区访问不了内网区的情况下，相关知识在第 1 章中已经详细讲解过，此处不再重 复。</p>
<p>2．办公区<br>办公区，顾名思义，是指公司员工日常的工作区。办公区的安全防护水平一般不是高，基本 防护机制大多为杀毒软件或主机入侵检测产品。在实际应用中，攻击者在获取权限后，利用内网 信任关系，很容易扩大攻击面。一般情况下，攻击者很少会直接到达办公区。攻击者如果想进入 办公区，可能会使用鱼叉攻击、水坑攻击或者社会工程学等手段。办公区按照系统可分为 OA 系统、邮件系统、财务系统、文件共享系统、域控、企业版杀毒 系统、内部应用监控系统、运维管理系统等，按照网络段可分为域管理网段、内部服务器系统网 段、各部门分区网段等。</p>
<p>3．核心区<br>核心区一般存放企业最重要的数据、文档等信息资产，如域控制器、核心生产机器等，安全 设置也最为严格。根据目标开展的业务不同，相关服务器可能存在于不同的网段上。通过分析服 务器上运行的服务和进程，可以推断出目标主机使用的运维监控管理系统和安全防护系。在内网 中横向移动时，会优先查找这些主机。核心区按照系统可分为业务系统、运维监控系统、安全系统等，按照网络段可分为各不同的 业务网段、运维监控网段、安全管理网段等。<br>通过获取的目标主机及所在域的各类信息，就可以绘制内网的拓扑结构图，在后续的渗透测 试中，对照拓扑图可以更快地了解目标域网内部环境，准确定位内网具体目标。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" rel="tag"># 网络安全</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/26/%E7%BB%95%E8%BF%87CDN%E5%AF%BB%E6%89%BE%E7%9C%9F%E5%AE%9EIP%E7%9A%848%E7%A7%8D%E6%96%B9%E6%B3%95/" rel="prev" title="绕过CDN寻找真实IP的8种方法">
      <i class="fa fa-chevron-left"></i> 绕过CDN寻找真实IP的8种方法
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/31/%E5%85%B3%E4%BA%8Ephar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" rel="next" title="关于phar反序列化漏洞挖掘">
      关于phar反序列化漏洞挖掘 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="bosch"
      src="/images/title1.jpg">
  <p class="site-author-name" itemprop="name">bosch</p>
  <div class="site-description" itemprop="description">在这片海洋中，如若无法向上攀游，就只有往下沉沦</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">bosch</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">107k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">1:37</span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"3nEcwhMJTxkWHiNp8cMyOlAI-gzGzoHsz","app_key":"wxnCuxw6V0b0lAgx5kOUUOSp","server_url":null,"security":true,"betterPerformance":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '3nEcwhMJTxkWHiNp8cMyOlAI-gzGzoHsz',
      appKey     : 'wxnCuxw6V0b0lAgx5kOUUOSp',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
